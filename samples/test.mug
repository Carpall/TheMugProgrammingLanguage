const std = import!("std")

const Allocator = std.mem.Allocator

const concat = std.str.concat

// immutable array
const Array = fn(static T: type): type {
  struct {
    let cache: *T
    let len: usize

    pub const Tsize = size!(T)
    const Self = Array(T)

    const initialize_cache = fn(mut len: usize, cache: *T) {
      const Tdefault = default!(T)
      while len > 0 {
        len -= 1

        *ptr_add!(cache, len * Tsize) = Tdefault
      }
    }

    const ptr_at = fn(self: Selfidx: usize): *T {
      ptr_add!(self.cache, idx * Tsize)
    }

    pub const len = fn(self: Self): usize {
      self.len
    }

    pub const `[]` = fn(self: Self, idx: usize): T {
      *ptr_at(idx)
    }

    pub const `[]=` = fn(self: Self, idx: usize, value: T) {
      *ptr_at(idx) = value
    }

    pub const create = fn(size: usize): Array(T) {
      let cache = Allocator.alloc_bytes(size * Tsize) as *T
      initialize_cache(size, cache)
      
      new Array { cache: cache, len: size }
    }
  }
}

const main = fn {
  let arr = Array(str).create(10)
  arr[0] = "2"
  arr[1] = "1"
  arr[2] = "0"
  arr[3] = arr[2].concat(arr[1]).concat(arr[0])
}