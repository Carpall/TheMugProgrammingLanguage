const io = import!(io)

const WordCounter = type {
  
  words: u32,
  pos: u64,
  text: str

  pub static const countInString = fn (text: str): u32 {
    let mut counter: WordCounter = new { text: text }
    counter.count()

    counter.words
  }

  const cur = fn (): chr { self.text[self.pos] }
    
  const bck = fn (): chr {
    if self.pos > 0 {
      self.text[self.pos - 1]
    } else { '\0' }
  }

  const count = fn {
    // ! is the first character in the ascii table http://www.asciitable.com/
    const isSpecial = fn (c: chr): bool { u8!(c) < u8!('!') }

    for self.pos = 0, self.pos < self.text.len, self.pos += 1 {
      if isSpecial(self.cur()) and !isSpecial(self.bck()) { self.words += 1 }
    }

    self.words += 1
  }
  
}

const getPath = fn (): option[str] {
  let args = args!()
  let len = args.len

  if len != 1 {
    println!("Expected 1 parameter, found {}", len)
    none!()
  } else {
    ok!(args[0])
  }
}

const main = fn (): option[void] {
  let path = try getPath()
  let mut file = File.open(path, FileMode.read)

  let count = WordCounter.countInString(file.readToEnd())

  println!("In path '{}' there are {} words", path, count)
}
