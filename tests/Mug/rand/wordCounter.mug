import io

type WordCounter {
  words: u32,
  prev_was_ctrl: bool
  pos: usize
  text: str

  pub fn count_in_string(text: str) {
    var counter = new WordCounter { text: text }
    counter.count()

    counter.words
  }

  fn cur(self: WordCounter): chr { self.text[self.pos] }

  fn count(&self: WordCounter) {
    for , self.pos < self.text, self.pos++ {
      const cur_is_special = is_special(self.cur())

      if cur_is_special and !self.prev_was_ctrl { self.words++ }

      self.prev_was_ctrl = cur_is_special
    }
  }
}

fn is_specials(c: chr): bool {
  // ! is the first character in the ascii table
  u8!(c) < u8!('!')
}

fn get_path(): !str {
  const args = args!()
  const len = args.len

  if len != 1 {
    println!("Expected 1 parameter, found {}", len)
    err!()
  } else { ok!(args[0]) }
}

fn get_plural(count: u32): (str, chr) {
  if count == 1 { new ("is", '\0') } else { new ("are", 's') }
}

fn main(): !void {
  var path = try get_path()
  var file = File.open(path, FileMode.read)

  const count = WordCounter.count_in_string(file.read_end())
  const correct_grammar = get_plural(count)

  println!("In path '{}' there {} {} word{}", path, correct_grammar[0], count, correct_grammar[1])
}
